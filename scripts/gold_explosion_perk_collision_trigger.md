---
title: Gold Explosion Perk Collision Trigger
category: scripts
---

# Gold Explosion Perk Collision Trigger

This script defines the behavior for the "Exploding Gold" perk in Noita. When a player picks up gold, this script triggers an explosion effect.

## Core Functionality

The `collision_trigger` function is the main logic. It's designed to be attached to an entity that acts as a trigger for the perk.

### Key Actions:

1.  **Entity Creation:** Spawns a `gold_explosion.xml` entity, which contains the visual and functional components of the explosion.
2.  **Gold Value Retrieval:** Reads the gold value associated with the perk from a `VariableStorageComponent`. Defaults to 10 if not found.
3.  **Player Identification:** Locates the player entity and retrieves their `herd_id` for damage attribution.
4.  **Perk State Check:** Reads a global flag (`PERK_PICKED_EXPLODING_GOLD_PICKUP_COUNT`) to determine how many times this perk has been picked up, influencing explosion scaling.
5.  **Explosion Parameter Calculation:** Dynamically calculates explosion radius, damage, and spark counts based on the collected gold value and perk pickup count.
6.  **Projectile Component Configuration:** Modifies the `ProjectileComponent` of the spawned explosion entity to apply the calculated parameters, including setting the shooter and preventing self-damage.

## Key Attributes & Calculations

The script dynamically adjusts explosion properties based on several factors:

### Gold Value:

*   Determines the base scale for radius, damage, and sparks.
*   Formulaic influence: `( value / ( 10 + value * 0.01 ) )`

### Perk Pickup Count:

*   Scales the explosion radius and damage further with each subsequent pickup of the "Exploding Gold" perk.
*   Radius scaling: `math.min( 60, ( 16 + ( pickup_count - 1 ) * 4 ) )`
*   Damage scaling: `math.min( 2.0, ( 0.4 + ( pickup_count - 1 ) * 0.2 ) )`

### Calculated Explosion Properties:

*   **`exp_radius`**: The area of effect for the explosion.
*   **`exp_damage`**: The damage dealt by the explosion.
*   **`exp_sparks_min` / `exp_sparks_max`**: The minimum and maximum number of sparks generated by the explosion.

## Code Structure

```lua
dofile_once("data/scripts/lib/utilities.lua")

function collision_trigger()
	-- Get the entity that triggered this script
	local entity_id = GetUpdatedEntityID()

	-- Load the explosion entity and make it a child of the trigger
	local eid = EntityLoad( "data/entities/misc/perks/gold_explosion.xml" )
	EntityAddChild( entity_id, eid )

	-- Default gold value
	local value = 10

	-- Retrieve gold value from VariableStorageComponent
	local comps = EntityGetComponent( entity_id, "VariableStorageComponent" )
	if ( comps ~= nil ) then
		for j,comp in ipairs( comps ) do
			local name = ComponentGetValue2( comp, "name" )
			if ( name == "gold_value" ) then
				value = ComponentGetValue2( comp, "value_int" )
				break
			end
		end
	end

	-- Find the player and their herd ID
	local players = EntityGetWithTag( "player_unit" )
	local herd_id = -1
	local player
	if ( #players > 0 ) then
		player = players[1]
		edit_component( player, "GenomeDataComponent", function(comp,vars)
			herd_id = ComponentGetValue2( comp, "herd_id" )
		end)
	end

	-- Get perk pickup count from global variables
	local flag_name = "PERK_PICKED_EXPLODING_GOLD"
	local pickup_count = tonumber( GlobalsGetValue( flag_name .. "_PICKUP_COUNT", "0" ) )

	-- Calculate explosion parameters
	local exp_radius = ( value / ( 10 + value * 0.01 ) ) + math.min( 60, ( 16 + ( pickup_count - 1 ) * 4 ) )
	-- local exp_shake = 0 -- (value / (10 + value * 0.01)) + 16 -- Shake is commented out
	local exp_damage = ( ( value / ( 10 + value * 0.01 ) ) + 1.5 ) * math.min( 2.0, ( 0.4 + ( pickup_count - 1 ) * 0.2 ) )

	local exp_sparks_min = math.max( 5, math.floor( exp_radius * 0.75 ) )
	local exp_sparks_max = math.max( 10, math.floor( exp_radius * 1.25 ) )

	-- Configure the explosion entity's ProjectileComponent
	edit_component( eid, "ProjectileComponent", function(comp,vars)
		ComponentObjectSetValue( comp, "config_explosion", "explosion_radius", exp_radius )
		-- ComponentObjectSetValue( comp, "config_explosion", "camera_shake", exp_shake ) -- Shake is commented out
		ComponentObjectSetValue( comp, "config_explosion", "damage", exp_damage )

		ComponentObjectSetValue( comp, "config_explosion", "sparks_count_min", exp_sparks_min )
		ComponentObjectSetValue( comp, "config_explosion", "sparks_count_max", exp_sparks_max )

		-- Set shooter information if player is found
		if ( player ~= nil ) then
			ComponentSetValue2( comp, "mWhoShot", player )
			ComponentSetValue2( comp, "mShooterHerdId", herd_id )
			ComponentObjectSetValue( comp, "config_explosion", "dont_damage_this", player )
		end
	end)
end
```